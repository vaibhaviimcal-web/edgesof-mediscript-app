<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EdgesOf MediScript - AI-Powered System (Phase 8)</title>
  <link rel="icon" href="https://nyc3.digitaloceanspaces.com/bhindi-drive/files/cab453ed-7d3e-4dfa-9012-038dbc50c1c5/2025-12-07T15-33-38-867Z-c50befdf-chat-image-1765121618851-0.jpg">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%); }
    
    .btn { padding: 12px 28px; border-radius: 12px; font-weight: 600; transition: all 0.3s; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; border: none; }
    .btn-sm { padding: 8px 16px; font-size: 14px; }
    .btn-primary { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4); }
    .btn-secondary { background: white; color: #1f2937; border: 2px solid #e5e7eb; }
    .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
    .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .btn-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .btn-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
    .btn-ai { background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); color: white; animation: aiGlow 2s infinite; }
    
    @keyframes aiGlow { 0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.5); } 50% { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); } }
    
    .card { background: white; border-radius: 20px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 10px 40px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.04); transition: all 0.3s; }
    .card:hover { transform: translateY(-4px); box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 20px 60px rgba(0,0,0,0.08); }
    
    .form-input { width: 100%; padding: 14px 18px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 15px; }
    .form-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    .form-label { display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
    
    .badge { display: inline-flex; padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; }
    .badge-primary { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e40af; }
    .badge-success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46; }
    .badge-warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color: #92400e; }
    .badge-danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; }
    .badge-purple { background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); color: #6b21a8; }
    .badge-ai { background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%); color: #86198f; border: 2px solid #ec4899; }
    
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; border-radius: 12px; color: rgba(255,255,255,0.8); transition: all 0.2s; text-decoration: none; cursor: pointer; }
    .nav-link:hover { background: rgba(255,255,255,0.1); color: white; }
    .nav-link.active { background: rgba(255,255,255,0.15); color: white; font-weight: 600; }
    
    .toast { position: fixed; bottom: 32px; right: 32px; background: white; border-radius: 16px; padding: 20px 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 16px; z-index: 9999; animation: slideIn 0.4s; border-left: 4px solid; max-width: 400px; }
    @keyframes slideIn { from { transform: translateX(500px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast-success { border-left-color: #10b981; }
    .toast-error { border-left-color: #ef4444; }
    .toast-info { border-left-color: #3b82f6; }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 9998; display: flex; align-items: center; justify-content: center; padding: 24px; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background: white; border-radius: 24px; max-width: 1200px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0,0,0,0.25); animation: scaleIn 0.4s; }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .ai-suggestion { border: 2px solid #ec4899; background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%); padding: 16px; border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; }
    .ai-suggestion:hover { transform: translateX(8px); box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3); }
    
    .voice-recording { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }
    
    .chatbot-container { position: fixed; bottom: 32px; right: 32px; width: 400px; height: 600px; background: white; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 9999; display: flex; flex-direction: column; }
    .chatbot-header { background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); color: white; padding: 20px; border-radius: 24px 24px 0 0; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
    .chatbot-messages { flex: 1; overflow-y: auto; padding: 20px; }
    .chatbot-input { padding: 20px; border-top: 1px solid #e5e7eb; }
    .message { margin-bottom: 16px; padding: 12px 16px; border-radius: 12px; max-width: 80%; }
    .message-user { background: #dbeafe; margin-left: auto; text-align: right; }
    .message-ai { background: #f3e8ff; }
    
    .invoice-table { width: 100%; border-collapse: collapse; }
    .invoice-table th, .invoice-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    .invoice-table th { background: #f9fafb; font-weight: 600; }
    
    .ai-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%); color: white; border-radius: 20px; font-size: 12px; font-weight: 600; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="chatbot"></div>

  <script>
    console.log('üöÄ EdgesOf MediScript - Phase 8: AI Foundation Loading...');
    
    // ============================================
    // CORE: DATABASE MODULE
    // ============================================
    const DB = {
      clinics: [{
        id: 'clinic-1',
        name: 'City Health Clinic',
        logo_url: 'https://nyc3.digitaloceanspaces.com/bhindi-drive/files/cab453ed-7d3e-4dfa-9012-038dbc50c1c5/2025-12-07T15-33-38-867Z-c50befdf-chat-image-1765121618851-0.jpg',
        gstin: '27AABCU9603R1ZM',
        state_code: '27',
        place_of_business: 'Maharashtra',
        address: '123 Medical Street, Mumbai',
        phone: '+91 22 1234 5678',
        email: 'info@cityhealthclinic.com',
        primary_color: '#2563eb',
        secondary_color: '#10b981'
      }],
      patients: [
        {id: 'p1', patient_id: 'P001', first_name: 'Rajesh', last_name: 'Kumar', age: 45, gender: 'Male', blood_group: 'O+', phone: '+919876543220', email: 'rajesh@example.com'},
        {id: 'p2', patient_id: 'P002', first_name: 'Priya', last_name: 'Sharma', age: 32, gender: 'Female', blood_group: 'A+', phone: '+919876543221', email: 'priya@example.com'},
        {id: 'p3', patient_id: 'P003', first_name: 'Amit', last_name: 'Patel', age: 28, gender: 'Male', blood_group: 'B+', phone: '+919876543222', email: 'amit@example.com'}
      ],
      medicines: [
        {id: 'm1', name: 'Paracetamol', generic_name: 'Paracetamol', brand_name: 'Crocin', strength: '500', unit: 'mg', form: 'Tablet', category: 'Analgesic', schedule: 'OTC', price: 5, mrp: 6, hsn_code: '30049099', indications: ['fever', 'pain', 'headache']},
        {id: 'm2', name: 'Amoxicillin', generic_name: 'Amoxicillin', brand_name: 'Novamox', strength: '500', unit: 'mg', form: 'Capsule', category: 'Antibiotic', schedule: 'H', price: 15, mrp: 18, hsn_code: '30042090', indications: ['bacterial infection', 'respiratory infection']},
        {id: 'm3', name: 'Azithromycin', generic_name: 'Azithromycin', brand_name: 'Azithral', strength: '500', unit: 'mg', form: 'Tablet', category: 'Antibiotic', schedule: 'H', price: 25, mrp: 30, hsn_code: '30042090', indications: ['bacterial infection', 'respiratory infection']},
        {id: 'm4', name: 'Cetirizine', generic_name: 'Cetirizine', brand_name: 'Zyrtec', strength: '10', unit: 'mg', form: 'Tablet', category: 'Antihistamine', schedule: 'OTC', price: 8, mrp: 10, hsn_code: '30049099', indications: ['allergy', 'cold', 'runny nose']},
        {id: 'm5', name: 'Omeprazole', generic_name: 'Omeprazole', brand_name: 'Omez', strength: '20', unit: 'mg', form: 'Capsule', category: 'PPI', schedule: 'H', price: 12, mrp: 15, hsn_code: '30049099', indications: ['acidity', 'gastritis', 'ulcer']}
      ],
      prescriptions: [],
      invoices: [],
      opd_queue: [],
      vital_signs: [],
      soap_notes: [],
      lab_orders: [],
      icd10_codes: [
        {code: 'J06.9', description: 'Acute upper respiratory infection', category: 'Respiratory', symptoms: ['fever', 'cough', 'cold', 'sore throat']},
        {code: 'A09', description: 'Infectious gastroenteritis', category: 'Infectious', symptoms: ['diarrhea', 'vomiting', 'stomach pain']},
        {code: 'I10', description: 'Essential hypertension', category: 'Circulatory', symptoms: ['high bp', 'headache', 'dizziness']},
        {code: 'E11.9', description: 'Type 2 diabetes mellitus', category: 'Endocrine', symptoms: ['high sugar', 'thirst', 'frequent urination']},
        {code: 'R50.9', description: 'Fever, unspecified', category: 'Symptoms', symptoms: ['fever', 'high temperature']},
        {code: 'R51', description: 'Headache', category: 'Symptoms', symptoms: ['headache', 'head pain']},
        {code: 'K21', description: 'Gastro-esophageal reflux disease', category: 'Digestive', symptoms: ['acidity', 'heartburn', 'chest pain']}
      ],
      soap_templates: [
        {id: 't1', name: 'Viral Fever', icon: 'ü§í', chief_complaint: 'Fever for 3 days', subjective: 'Patient reports fever for 3 days with body ache', objective: 'Temp: 101¬∞F, BP: 120/80', assessment: 'Viral fever', plan: 'Paracetamol 500mg TDS', icd10: 'J06.9'}
      ],
      lab_tests: [
        {id: 'lab1', name: 'CBC', category: 'Hematology', price: 300, normal_range: 'Hb: 12-16g/dL'},
        {id: 'lab2', name: 'LFT', category: 'Biochemistry', price: 500, normal_range: 'SGOT: 5-40 U/L'}
      ],
      // AI Knowledge Base
      ai_knowledge: {
        symptom_medicine_map: {
          'fever': ['Paracetamol', 'Ibuprofen'],
          'pain': ['Paracetamol', 'Ibuprofen'],
          'headache': ['Paracetamol', 'Ibuprofen'],
          'cold': ['Cetirizine', 'Paracetamol'],
          'cough': ['Amoxicillin', 'Azithromycin'],
          'allergy': ['Cetirizine'],
          'acidity': ['Omeprazole'],
          'infection': ['Amoxicillin', 'Azithromycin']
        },
        drug_interactions: {
          'Paracetamol': ['Avoid alcohol', 'Max 4g/day'],
          'Amoxicillin': ['Take with food', 'Complete full course'],
          'Azithromycin': ['Take on empty stomach', 'Avoid antacids']
        }
      }
    };

    const supabase = {
      from: (table) => ({
        select: () => ({ order: () => Promise.resolve({ data: DB[table] || [], error: null }), eq: (col, val) => Promise.resolve({ data: (DB[table] || []).filter(i => i[col] === val), error: null }) }),
        insert: (data) => { const items = Array.isArray(data) ? data : [data]; const newItems = items.map(i => ({ id: 'uuid-' + Date.now() + '-' + Math.random(), created_at: new Date().toISOString(), ...i })); DB[table].push(...newItems); return Promise.resolve({ data: newItems, error: null }); },
        update: (data) => ({ eq: (col, val) => { const idx = DB[table].findIndex(i => i[col] === val); if (idx !== -1) DB[table][idx] = { ...DB[table][idx], ...data }; return Promise.resolve({ data: [DB[table][idx]], error: null }); } })
      })
    };

    // ============================================
    // CORE: STATE MANAGEMENT
    // ============================================
    let currentScreen = 'consent';
    let currentUser = null;
    let userConsent = false;
    let currentPrescription = { patient_id: null, medicines: [], diagnosis: '' };
    let currentInvoice = { items: [], subtotal: 0, cgst: 0, sgst: 0, total: 0 };
    let isRecording = false;
    let chatbotOpen = false;
    let chatMessages = [];

    // ============================================
    // UTILS: HELPER FUNCTIONS
    // ============================================
    function getClinic() { return DB.clinics[0]; }
    
    function showToast(msg, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ';
      toast.innerHTML = `<div class="text-2xl">${icon}</div><div><p class="font-semibold text-sm">${msg}</p></div>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    function closeModal() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
    }

    function calculateGST(amount, rate = 18) {
      const gstAmount = (amount * rate) / 100;
      return { cgst: gstAmount / 2, sgst: gstAmount / 2, total: gstAmount };
    }

    // ============================================
    // AI MODULE 1: AI PRESCRIPTION ASSISTANT
    // ============================================
    function getAISuggestions(diagnosis) {
      const diagnosisLower = diagnosis.toLowerCase();
      const suggestions = [];
      
      // Match symptoms to medicines
      for (const [symptom, medicines] of Object.entries(DB.ai_knowledge.symptom_medicine_map)) {
        if (diagnosisLower.includes(symptom)) {
          medicines.forEach(medName => {
            const medicine = DB.medicines.find(m => m.name === medName || m.generic_name === medName);
            if (medicine && !suggestions.find(s => s.id === medicine.id)) {
              suggestions.push({
                ...medicine,
                reason: `Recommended for ${symptom}`,
                confidence: 85 + Math.floor(Math.random() * 15)
              });
            }
          });
        }
      }
      
      return suggestions.slice(0, 3);
    }

    function showAISuggestions(diagnosis) {
      const suggestions = getAISuggestions(diagnosis);
      if (suggestions.length === 0) return '';
      
      return `
        <div class="mb-6 p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl border-2 border-pink-300">
          <div class="flex items-center gap-2 mb-3">
            <span class="ai-badge">ü§ñ AI Assistant</span>
            <p class="font-bold text-gray-800">Suggested Medicines</p>
          </div>
          <div class="space-y-2">
            ${suggestions.map(s => `
              <div class="ai-suggestion" onclick="addAISuggestedMedicine('${s.id}')">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-bold text-gray-900">${s.name} (${s.brand_name})</p>
                    <p class="text-sm text-gray-600">${s.strength}${s.unit} ${s.form}</p>
                    <p class="text-xs text-purple-600 mt-1">üí° ${s.reason}</p>
                  </div>
                  <div class="text-right">
                    <span class="badge badge-ai">${s.confidence}% Match</span>
                    <p class="text-xs text-gray-500 mt-1">Click to add</p>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function addAISuggestedMedicine(medicineId) {
      addMedicineToPrescription(medicineId);
      showToast('AI suggested medicine added!', 'success');
    }

    // ============================================
    // AI MODULE 2: VOICE-TO-TEXT
    // ============================================
    let recognition = null;
    let currentVoiceField = null;

    function initVoiceRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-IN'; // English (India) - supports Hindi-English mix
        
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          if (currentVoiceField) {
            document.getElementById(currentVoiceField).value += (document.getElementById(currentVoiceField).value ? ' ' : '') + transcript;
          }
          showToast('Voice recorded: ' + transcript, 'success');
        };
        
        recognition.onerror = (event) => {
          showToast('Voice recognition error: ' + event.error, 'error');
          stopVoiceRecording();
        };
        
        recognition.onend = () => {
          stopVoiceRecording();
        };
      }
    }

    function startVoiceRecording(fieldId) {
      if (!recognition) {
        showToast('Voice recognition not supported in this browser', 'error');
        return;
      }
      
      currentVoiceField = fieldId;
      isRecording = true;
      recognition.start();
      
      const btn = document.getElementById('voiceBtn-' + fieldId);
      if (btn) {
        btn.classList.add('voice-recording');
        btn.innerHTML = '‚èπÔ∏è Stop Recording';
      }
      
      showToast('üé§ Listening... Speak now!', 'info');
    }

    function stopVoiceRecording() {
      if (recognition && isRecording) {
        recognition.stop();
      }
      isRecording = false;
      currentVoiceField = null;
      
      document.querySelectorAll('[id^="voiceBtn-"]').forEach(btn => {
        btn.classList.remove('voice-recording');
        btn.innerHTML = 'üé§ Voice Input';
      });
    }

    function toggleVoiceRecording(fieldId) {
      if (isRecording) {
        stopVoiceRecording();
      } else {
        startVoiceRecording(fieldId);
      }
    }

    // ============================================
    // AI MODULE 3: AI DIAGNOSIS SUPPORT
    // ============================================
    function getAIDiagnosisSuggestions(symptoms) {
      const symptomsLower = symptoms.toLowerCase();
      const suggestions = [];
      
      DB.icd10_codes.forEach(code => {
        if (code.symptoms) {
          const matchCount = code.symptoms.filter(s => symptomsLower.includes(s)).length;
          if (matchCount > 0) {
            suggestions.push({
              ...code,
              matchScore: (matchCount / code.symptoms.length) * 100,
              matchedSymptoms: code.symptoms.filter(s => symptomsLower.includes(s))
            });
          }
        }
      });
      
      return suggestions.sort((a, b) => b.matchScore - a.matchScore).slice(0, 3);
    }

    function showAIDiagnosisHelper() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center" style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);">
            <div>
              <h2 class="text-2xl font-bold text-white">ü§ñ AI Diagnosis Assistant</h2>
              <p class="text-sm text-white opacity-90 mt-1">Describe symptoms for AI-powered diagnosis suggestions</p>
            </div>
            <button onclick="closeModal()" class="text-white hover:text-gray-200 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div class="mb-6">
              <label class="form-label">Describe Patient Symptoms</label>
              <textarea id="aiSymptoms" class="form-input" rows="4" placeholder="e.g., Patient has fever for 3 days, cough, and body ache..."></textarea>
              <button onclick="analyzeSymptoms()" class="btn btn-ai mt-3">üß† Analyze with AI</button>
            </div>
            <div id="aiDiagnosisResults"></div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function analyzeSymptoms() {
      const symptoms = document.getElementById('aiSymptoms').value;
      if (!symptoms) {
        showToast('Please describe symptoms', 'error');
        return;
      }
      
      const suggestions = getAIDiagnosisSuggestions(symptoms);
      
      document.getElementById('aiDiagnosisResults').innerHTML = `
        <div class="p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl border-2 border-pink-300">
          <h3 class="font-bold mb-4 flex items-center gap-2">
            <span class="ai-badge">ü§ñ AI Analysis</span>
            <span>Possible Diagnoses</span>
          </h3>
          ${suggestions.length === 0 ? '<p class="text-gray-600">No matching diagnoses found. Please provide more details.</p>' : suggestions.map(s => `
            <div class="ai-suggestion mb-3">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <p class="font-bold text-gray-900">${s.code} - ${s.description}</p>
                  <p class="text-sm text-gray-600 mt-1">Category: ${s.category}</p>
                  <p class="text-xs text-purple-600 mt-2">
                    ‚úì Matched symptoms: ${s.matchedSymptoms.join(', ')}
                  </p>
                </div>
                <div class="text-right">
                  <span class="badge badge-ai">${Math.round(s.matchScore)}% Match</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // ============================================
    // AI MODULE 4: AI CHATBOT
    // ============================================
    function toggleChatbot() {
      chatbotOpen = !chatbotOpen;
      renderChatbot();
    }

    function renderChatbot() {
      const chatbotDiv = document.getElementById('chatbot');
      
      if (!chatbotOpen) {
        chatbotDiv.innerHTML = `
          <button onclick="toggleChatbot()" class="btn btn-ai" style="position: fixed; bottom: 32px; right: 32px; z-index: 9999; border-radius: 50%; width: 64px; height: 64px; padding: 0; font-size: 28px;">
            ü§ñ
          </button>
        `;
        return;
      }
      
      chatbotDiv.innerHTML = `
        <div class="chatbot-container">
          <div class="chatbot-header">
            <div>
              <div class="text-lg">ü§ñ AI Medical Assistant</div>
              <div class="text-xs opacity-80">Ask me anything!</div>
            </div>
            <button onclick="toggleChatbot()" class="text-white hover:text-gray-200 text-2xl">√ó</button>
          </div>
          <div class="chatbot-messages" id="chatMessages">
            ${chatMessages.length === 0 ? `
              <div class="message message-ai">
                <p class="text-sm">üëã Hello! I'm your AI medical assistant. I can help you with:</p>
                <ul class="text-sm mt-2 space-y-1">
                  <li>‚Ä¢ Medicine information</li>
                  <li>‚Ä¢ Symptom analysis</li>
                  <li>‚Ä¢ Appointment booking</li>
                  <li>‚Ä¢ General health queries</li>
                </ul>
              </div>
            ` : chatMessages.map(m => `
              <div class="message ${m.type === 'user' ? 'message-user' : 'message-ai'}">
                <p class="text-sm">${m.text}</p>
              </div>
            `).join('')}
          </div>
          <div class="chatbot-input">
            <div class="flex gap-2">
              <input type="text" id="chatInput" class="form-input" placeholder="Type your question..." onkeypress="if(event.key==='Enter') sendChatMessage()">
              <button onclick="sendChatMessage()" class="btn btn-ai">Send</button>
            </div>
          </div>
        </div>
      `;
    }

    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;
      
      chatMessages.push({ type: 'user', text: message });
      input.value = '';
      
      // AI Response
      setTimeout(() => {
        const response = getAIChatResponse(message);
        chatMessages.push({ type: 'ai', text: response });
        renderChatbot();
        
        const messagesDiv = document.getElementById('chatMessages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, 500);
      
      renderChatbot();
    }

    function getAIChatResponse(message) {
      const msgLower = message.toLowerCase();
      
      if (msgLower.includes('fever') || msgLower.includes('temperature')) {
        return 'ü§í For fever, I recommend Paracetamol 500mg. Take it with water after meals. If fever persists for more than 3 days, please consult a doctor.';
      }
      if (msgLower.includes('headache') || msgLower.includes('head pain')) {
        return 'üíä For headache, you can take Paracetamol or Ibuprofen. Make sure to stay hydrated and rest. If headache is severe or persistent, consult a doctor.';
      }
      if (msgLower.includes('appointment') || msgLower.includes('book')) {
        return 'üìÖ To book an appointment, please go to the Appointments section or call us at +91 22 1234 5678. Our OPD hours are 9 AM to 5 PM.';
      }
      if (msgLower.includes('medicine') || msgLower.includes('drug')) {
        return 'üíä We have a wide range of medicines available. You can search for specific medicines in the Prescription section. All medicines are dispensed as per doctor\'s prescription.';
      }
      
      return 'ü§ñ I understand your query. For specific medical advice, please consult with our doctors. You can book an appointment or visit our OPD. Is there anything else I can help you with?';
    }

    // ============================================
    // AI MODULE 5: SMART MEDICINE SEARCH
    // ============================================
    function smartMedicineSearch(query) {
      if (!query || query.length < 2) return [];
      
      const queryLower = query.toLowerCase();
      const results = [];
      
      // Search by name, generic name, brand name
      DB.medicines.forEach(m => {
        let score = 0;
        if (m.name.toLowerCase().includes(queryLower)) score += 10;
        if (m.generic_name.toLowerCase().includes(queryLower)) score += 8;
        if (m.brand_name.toLowerCase().includes(queryLower)) score += 6;
        if (m.category.toLowerCase().includes(queryLower)) score += 4;
        
        // Search by indications (AI-powered)
        if (m.indications) {
          m.indications.forEach(ind => {
            if (queryLower.includes(ind) || ind.includes(queryLower)) score += 15;
          });
        }
        
        if (score > 0) {
          results.push({ ...m, searchScore: score });
        }
      });
      
      return results.sort((a, b) => b.searchScore - a.searchScore);
    }

    // ============================================
    // AUTH MODULE
    // ============================================
    async function acceptConsent() {
      userConsent = true;
      currentScreen = 'login';
      render();
    }

    async function login() {
      currentUser = { name: 'Dr. Rajesh Sharma', email: 'doctor@clinic.com', role: 'doctor', can_prescribe_h: true, can_prescribe_h1: true };
      currentScreen = 'dashboard';
      initVoiceRecognition();
      showToast('ü§ñ AI-Powered System Active! Phase 8 Complete!', 'success');
      render();
    }

    function logout() {
      currentUser = null;
      userConsent = false;
      currentScreen = 'consent';
      chatbotOpen = false;
      render();
    }

    function switchScreen(screen) {
      currentScreen = screen;
      render();
    }

    // ============================================
    // PATIENT MODULE (Phase 1)
    // ============================================
    function showAddPatientModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center">
            <h2 class="text-2xl font-bold">üë§ Add New Patient</h2>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div class="grid grid-cols-2 gap-6 mb-6">
              <div><label class="form-label">First Name *</label><input type="text" id="patientFirstName" class="form-input" placeholder="John"></div>
              <div><label class="form-label">Last Name</label><input type="text" id="patientLastName" class="form-input" placeholder="Doe"></div>
            </div>
            <div class="grid grid-cols-3 gap-6 mb-6">
              <div><label class="form-label">Age *</label><input type="number" id="patientAge" class="form-input" placeholder="30"></div>
              <div><label class="form-label">Gender *</label><select id="patientGender" class="form-input"><option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
              <div><label class="form-label">Blood Group</label><select id="patientBloodGroup" class="form-input"><option value="">Select</option><option value="O+">O+</option><option value="A+">A+</option><option value="B+">B+</option></select></div>
            </div>
            <div class="grid grid-cols-2 gap-6 mb-6">
              <div><label class="form-label">Phone *</label><input type="tel" id="patientPhone" class="form-input" placeholder="+91 98765 43210"></div>
              <div><label class="form-label">Email</label><input type="email" id="patientEmail" class="form-input" placeholder="patient@example.com"></div>
            </div>
            <div class="flex gap-4">
              <button onclick="saveNewPatient()" class="btn btn-success">üíæ Save Patient</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveNewPatient() {
      const firstName = document.getElementById('patientFirstName').value;
      const age = document.getElementById('patientAge').value;
      const gender = document.getElementById('patientGender').value;
      const phone = document.getElementById('patientPhone').value;

      if (!firstName || !age || !gender || !phone) {
        showToast('Please fill all required fields', 'error');
        return;
      }

      const patientId = 'P' + String(DB.patients.length + 1).padStart(3, '0');
      const newPatient = {
        patient_id: patientId,
        first_name: firstName,
        last_name: document.getElementById('patientLastName').value,
        age: parseInt(age),
        gender: gender,
        blood_group: document.getElementById('patientBloodGroup').value,
        phone: phone,
        email: document.getElementById('patientEmail').value
      };

      await supabase.from('patients').insert([newPatient]);
      showToast(`Patient ${firstName} added! ID: ${patientId}`, 'success');
      closeModal();
      render();
    }

    // ============================================
    // PRESCRIPTION MODULE (Phase 2) - WITH AI
    // ============================================
    function showPrescriptionModal(patientId) {
      currentPrescription = { patient_id: patientId, medicines: [], diagnosis: '' };
      const patient = DB.patients.find(p => p.id === patientId);
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üíä Create Prescription <span class="ai-badge ml-2">ü§ñ AI Powered</span></h2>
              <p class="text-sm text-gray-600 mt-1">Patient: ${patient?.first_name} ${patient?.last_name || ''}</p>
            </div>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div class="mb-6">
              <label class="form-label">Diagnosis</label>
              <input type="text" id="diagnosis" class="form-input" placeholder="e.g., Fever, Cough" oninput="updateAISuggestions()">
            </div>
            
            <div id="aiSuggestionsContainer"></div>
            
            <div class="mb-6">
              <label class="form-label">Search Medicine <span class="ai-badge ml-2">üîç Smart Search</span></label>
              <input type="text" id="medicineSearch" class="form-input" placeholder="Search by name, symptom, or condition..." oninput="smartSearchMedicine(this.value)">
              <div id="medicineResults" class="mt-2"></div>
            </div>
            
            <div class="mb-6">
              <h3 class="font-bold mb-3">Prescribed Medicines</h3>
              <div id="prescribedMedicines" class="space-y-3">
                <p class="text-gray-500 text-sm">No medicines added yet</p>
              </div>
            </div>
            
            <div class="flex gap-4">
              <button onclick="savePrescription()" class="btn btn-success">Save Prescription</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function updateAISuggestions() {
      const diagnosis = document.getElementById('diagnosis').value;
      currentPrescription.diagnosis = diagnosis;
      
      if (diagnosis.length > 3) {
        document.getElementById('aiSuggestionsContainer').innerHTML = showAISuggestions(diagnosis);
      } else {
        document.getElementById('aiSuggestionsContainer').innerHTML = '';
      }
    }

    function smartSearchMedicine(query) {
      if (!query || query.length < 2) { 
        document.getElementById('medicineResults').innerHTML = ''; 
        return; 
      }
      
      const results = smartMedicineSearch(query);
      
      document.getElementById('medicineResults').innerHTML = results.map(m => `
        <div class="p-4 border rounded-xl cursor-pointer hover:bg-blue-50 transition" onclick="addMedicineToPrescription('${m.id}')">
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold">${m.name} (${m.brand_name})</p>
              <p class="text-sm text-gray-600">${m.strength}${m.unit} ${m.form}</p>
              ${m.indications ? `<p class="text-xs text-purple-600 mt-1">üí° For: ${m.indications.join(', ')}</p>` : ''}
            </div>
            <div class="text-right">
              <span class="badge badge-${m.schedule === 'H' ? 'warning' : 'success'}">${m.schedule}</span>
              ${m.searchScore ? `<p class="text-xs text-gray-500 mt-1">${Math.round(m.searchScore * 10)}% match</p>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function addMedicineToPrescription(medicineId) {
      const medicine = DB.medicines.find(m => m.id === medicineId);
      
      // Check for drug interactions
      if (DB.ai_knowledge.drug_interactions[medicine.name]) {
        const warnings = DB.ai_knowledge.drug_interactions[medicine.name];
        showToast(`‚ö†Ô∏è ${medicine.name}: ${warnings.join(', ')}`, 'info');
      }
      
      currentPrescription.medicines.push({ 
        ...medicine, 
        dosage: '1 tablet', 
        frequency: 'Twice daily', 
        duration: '5 days' 
      });
      
      document.getElementById('medicineSearch').value = '';
      document.getElementById('medicineResults').innerHTML = '';
      updatePrescribedMedicinesList();
    }

    function updatePrescribedMedicinesList() {
      document.getElementById('prescribedMedicines').innerHTML = currentPrescription.medicines.map((m, idx) => `
        <div class="p-4 bg-gray-50 rounded-xl">
          <div class="flex justify-between items-start mb-3">
            <div>
              <p class="font-bold">${idx + 1}. ${m.name} (${m.brand_name})</p>
              <p class="text-sm text-gray-600">${m.strength}${m.unit} ${m.form}</p>
            </div>
            <button onclick="removeMedicineFromPrescription(${idx})" class="text-red-600">‚úï</button>
          </div>
        </div>
      `).join('');
    }

    function removeMedicineFromPrescription(index) {
      currentPrescription.medicines.splice(index, 1);
      updatePrescribedMedicinesList();
    }

    async function savePrescription() {
      const diagnosis = document.getElementById('diagnosis').value;
      if (!diagnosis || currentPrescription.medicines.length === 0) { 
        showToast('Please add diagnosis and medicines', 'error'); 
        return; 
      }
      
      await supabase.from('prescriptions').insert([{ 
        ...currentPrescription, 
        diagnosis: [diagnosis], 
        prescription_number: 'RX' + Date.now() 
      }]);
      
      showToast('‚úÖ Prescription created with AI assistance!', 'success');
      closeModal();
      render();
    }

    // ============================================
    // BILLING MODULE (Phase 2)
    // ============================================
    function showInvoiceModal(patientId) {
      currentInvoice = { patient_id: patientId, items: [], subtotal: 0, cgst: 0, sgst: 0, total: 0 };
      const patient = DB.patients.find(p => p.id === patientId);
      const clinic = getClinic();
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b">
            <h2 class="text-2xl font-bold mb-2">üí∞ GST Tax Invoice</h2>
            <div class="grid grid-cols-2 gap-6 text-sm">
              <div><p class="font-bold">${clinic.name}</p><p class="text-gray-600">GSTIN: ${clinic.gstin}</p></div>
              <div class="text-right"><p class="font-bold">Bill To:</p><p>${patient?.first_name} ${patient?.last_name || ''}</p></div>
            </div>
          </div>
          <div class="p-8">
            <div class="mb-6">
              <label class="form-label">Add Item</label>
              <div class="grid grid-cols-5 gap-3">
                <input type="text" id="itemDesc" class="form-input col-span-2" placeholder="Description">
                <input type="number" id="itemQty" class="form-input" placeholder="Qty" value="1">
                <input type="number" id="itemPrice" class="form-input" placeholder="Price">
                <button onclick="addInvoiceItem()" class="btn btn-primary">Add</button>
              </div>
            </div>
            <table class="invoice-table mb-6">
              <thead><tr><th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th><th>CGST (9%)</th><th>SGST (9%)</th><th>Total</th><th></th></tr></thead>
              <tbody id="invoiceItems"><tr><td colspan="8" class="text-center text-gray-500">No items added</td></tr></tbody>
            </table>
            <div class="bg-gray-50 p-6 rounded-xl">
              <div class="flex justify-between mb-2"><span class="font-semibold">Subtotal:</span><span>‚Çπ${currentInvoice.subtotal.toFixed(2)}</span></div>
              <div class="flex justify-between mb-2"><span class="font-semibold">CGST (9%):</span><span>‚Çπ${currentInvoice.cgst.toFixed(2)}</span></div>
              <div class="flex justify-between mb-2"><span class="font-semibold">SGST (9%):</span><span>‚Çπ${currentInvoice.sgst.toFixed(2)}</span></div>
              <div class="flex justify-between text-xl font-bold border-t-2 pt-2 mt-2"><span>Total:</span><span>‚Çπ${currentInvoice.total.toFixed(2)}</span></div>
            </div>
            <div class="flex gap-4 mt-6">
              <button onclick="saveInvoice()" class="btn btn-success">Save Invoice</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function addInvoiceItem() {
      const desc = document.getElementById('itemDesc').value;
      const qty = parseInt(document.getElementById('itemQty').value) || 1;
      const price = parseFloat(document.getElementById('itemPrice').value) || 0;
      if (!desc || !price) { showToast('Enter description and price', 'error'); return; }
      
      const amount = qty * price;
      const gst = calculateGST(amount);
      currentInvoice.items.push({ 
        description: desc, 
        quantity: qty, 
        unit_price: price, 
        taxable_amount: amount, 
        cgst_amount: gst.cgst, 
        sgst_amount: gst.sgst, 
        total: amount + gst.total 
      });
      
      currentInvoice.subtotal = currentInvoice.items.reduce((sum, item) => sum + item.taxable_amount, 0);
      currentInvoice.cgst = currentInvoice.items.reduce((sum, item) => sum + item.cgst_amount, 0);
      currentInvoice.sgst = currentInvoice.items.reduce((sum, item) => sum + item.sgst_amount, 0);
      currentInvoice.total = currentInvoice.subtotal + currentInvoice.cgst + currentInvoice.sgst;
      
      document.getElementById('itemDesc').value = '';
      document.getElementById('itemQty').value = '1';
      document.getElementById('itemPrice').value = '';
      updateInvoiceItemsList();
    }

    function updateInvoiceItemsList() {
      document.getElementById('invoiceItems').innerHTML = currentInvoice.items.map((item, idx) => `
        <tr>
          <td>${item.description}</td>
          <td>${item.quantity}</td>
          <td>‚Çπ${item.unit_price.toFixed(2)}</td>
          <td>‚Çπ${item.taxable_amount.toFixed(2)}</td>
          <td>‚Çπ${item.cgst_amount.toFixed(2)}</td>
          <td>‚Çπ${item.sgst_amount.toFixed(2)}</td>
          <td>‚Çπ${item.total.toFixed(2)}</td>
          <td><button onclick="removeInvoiceItem(${idx})" class="text-red-600">‚úï</button></td>
        </tr>
      `).join('');
      
      const modal = document.querySelector('.modal-content');
      if (modal) {
        modal.querySelector('.bg-gray-50').innerHTML = `
          <div class="flex justify-between mb-2"><span class="font-semibold">Subtotal:</span><span>‚Çπ${currentInvoice.subtotal.toFixed(2)}</span></div>
          <div class="flex justify-between mb-2"><span class="font-semibold">CGST (9%):</span><span>‚Çπ${currentInvoice.cgst.toFixed(2)}</span></div>
          <div class="flex justify-between mb-2"><span class="font-semibold">SGST (9%):</span><span>‚Çπ${currentInvoice.sgst.toFixed(2)}</span></div>
          <div class="flex justify-between text-xl font-bold border-t-2 pt-2 mt-2"><span>Total:</span><span>‚Çπ${currentInvoice.total.toFixed(2)}</span></div>
        `;
      }
    }

    function removeInvoiceItem(index) {
      currentInvoice.items.splice(index, 1);
      currentInvoice.subtotal = currentInvoice.items.reduce((sum, item) => sum + item.taxable_amount, 0);
      currentInvoice.cgst = currentInvoice.items.reduce((sum, item) => sum + item.cgst_amount, 0);
      currentInvoice.sgst = currentInvoice.items.reduce((sum, item) => sum + item.sgst_amount, 0);
      currentInvoice.total = currentInvoice.subtotal + currentInvoice.cgst + currentInvoice.sgst;
      updateInvoiceItemsList();
    }

    async function saveInvoice() {
      if (currentInvoice.items.length === 0) { showToast('Add at least one item', 'error'); return; }
      await supabase.from('invoices').insert([{ ...currentInvoice, invoice_number: 'INV' + Date.now() }]);
      showToast('Invoice created!', 'success');
      closeModal();
      render();
    }

    // ============================================
    // OPD QUEUE MODULE (Phase 7)
    // ============================================
    function showAddToQueueModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center">
            <h2 class="text-2xl font-bold">üé´ Add to OPD Queue</h2>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div class="mb-6">
              <label class="form-label">Select Patient</label>
              <select id="queuePatient" class="form-input">
                <option value="">Select Patient</option>
                ${DB.patients.map(p => `<option value="${p.id}">${p.first_name} ${p.last_name || ''} (${p.patient_id})</option>`).join('')}
              </select>
            </div>
            <div class="mb-6">
              <label class="form-label">Chief Complaint</label>
              <input type="text" id="chiefComplaint" class="form-input" placeholder="e.g., Fever, Cough">
            </div>
            <div class="flex gap-4">
              <button onclick="addToQueue()" class="btn btn-success">üé´ Generate Token</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function addToQueue() {
      const patientId = document.getElementById('queuePatient').value;
      if (!patientId) { showToast('Select a patient', 'error'); return; }
      
      const patient = DB.patients.find(p => p.id === patientId);
      const today = new Date().toISOString().split('T')[0];
      const todayQueue = DB.opd_queue.filter(q => q.date === today);
      const tokenNumber = todayQueue.length + 1;
      
      await supabase.from('opd_queue').insert([{ 
        patient_id: patientId, 
        patient_name: `${patient.first_name} ${patient.last_name || ''}`, 
        token_number: tokenNumber, 
        chief_complaint: document.getElementById('chiefComplaint').value, 
        status: 'waiting', 
        date: today 
      }]);
      
      showToast(`Token #${tokenNumber} generated!`, 'success');
      closeModal();
      render();
    }

    // ============================================
    // VITAL SIGNS MODULE (Phase 7)
    // ============================================
    function showVitalSignsModal(patientId) {
      const patient = DB.patients.find(p => p.id === patientId);
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">ü©∫ Record Vital Signs</h2>
              <p class="text-sm text-gray-600 mt-1">Patient: ${patient.first_name} ${patient.last_name || ''}</p>
            </div>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div class="grid grid-cols-3 gap-6 mb-6">
              <div>
                <label class="form-label">BP (mmHg)</label>
                <div class="flex gap-2">
                  <input type="number" id="bpSystolic" class="form-input" style="width:100px" placeholder="120">
                  <span class="text-2xl">/</span>
                  <input type="number" id="bpDiastolic" class="form-input" style="width:100px" placeholder="80">
                </div>
              </div>
              <div><label class="form-label">Pulse (bpm)</label><input type="number" id="pulse" class="form-input" placeholder="72"></div>
              <div><label class="form-label">Temp (¬∞F)</label><input type="number" step="0.1" id="temperature" class="form-input" placeholder="98.6"></div>
            </div>
            <div class="flex gap-4">
              <button onclick="saveVitalSigns('${patientId}')" class="btn btn-success">üíæ Save</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveVitalSigns(patientId) {
      await supabase.from('vital_signs').insert([{ 
        patient_id: patientId, 
        bp_systolic: document.getElementById('bpSystolic').value, 
        bp_diastolic: document.getElementById('bpDiastolic').value, 
        pulse: document.getElementById('pulse').value, 
        temperature: document.getElementById('temperature').value 
      }]);
      
      showToast('Vital signs recorded!', 'success');
      closeModal();
      render();
    }

    // ============================================
    // SOAP NOTES MODULE (Phase 7) - WITH VOICE
    // ============================================
    function showSOAPNotesModal(patientId) {
      const patient = DB.patients.find(p => p.id === patientId);
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üìã SOAP Notes <span class="ai-badge ml-2">üé§ Voice Enabled</span></h2>
              <p class="text-sm text-gray-600 mt-1">Patient: ${patient.first_name} ${patient.last_name || ''}</p>
            </div>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div class="mb-6">
              <h3 class="font-bold mb-3">üöÄ Quick Templates</h3>
              <div class="grid grid-cols-5 gap-3">
                ${DB.soap_templates.map(t => `
                  <div class="p-4 border-2 rounded-xl text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50" onclick="applySOAPTemplate('${t.id}')">
                    <div class="text-3xl mb-2">${t.icon}</div>
                    <p class="font-semibold text-sm">${t.name}</p>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="mb-6">
              <div class="flex justify-between items-center mb-2">
                <label class="form-label mb-0">Chief Complaint</label>
                <button id="voiceBtn-chiefComplaintSOAP" onclick="toggleVoiceRecording('chiefComplaintSOAP')" class="btn btn-sm btn-purple">üé§ Voice Input</button>
              </div>
              <input type="text" id="chiefComplaintSOAP" class="form-input" placeholder="e.g., Fever for 3 days">
            </div>
            
            <div class="mb-6">
              <div class="flex justify-between items-center mb-2">
                <label class="form-label mb-0">S - Subjective</label>
                <button id="voiceBtn-subjective" onclick="toggleVoiceRecording('subjective')" class="btn btn-sm btn-purple">üé§ Voice Input</button>
              </div>
              <textarea id="subjective" class="form-input" rows="3" placeholder="Patient's complaints..."></textarea>
            </div>
            
            <div class="mb-6">
              <div class="flex justify-between items-center mb-2">
                <label class="form-label mb-0">O - Objective</label>
                <button id="voiceBtn-objective" onclick="toggleVoiceRecording('objective')" class="btn btn-sm btn-purple">üé§ Voice Input</button>
              </div>
              <textarea id="objective" class="form-input" rows="3" placeholder="Examination findings..."></textarea>
            </div>
            
            <div class="mb-6">
              <label class="form-label">A - Assessment</label>
              <textarea id="assessment" class="form-input" rows="2" placeholder="Diagnosis..."></textarea>
            </div>
            
            <div class="mb-6">
              <label class="form-label">P - Plan</label>
              <textarea id="plan" class="form-input" rows="3" placeholder="Treatment plan..."></textarea>
            </div>
            
            <div class="flex gap-4">
              <button onclick="saveSOAPNotes('${patientId}')" class="btn btn-success">üíæ Save</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function applySOAPTemplate(templateId) {
      const template = DB.soap_templates.find(t => t.id === templateId);
      if (template) {
        document.getElementById('chiefComplaintSOAP').value = template.chief_complaint;
        document.getElementById('subjective').value = template.subjective;
        document.getElementById('objective').value = template.objective;
        document.getElementById('assessment').value = template.assessment;
        document.getElementById('plan').value = template.plan;
        showToast(`Template "${template.name}" applied!`, 'success');
      }
    }

    async function saveSOAPNotes(patientId) {
      await supabase.from('soap_notes').insert([{ 
        patient_id: patientId, 
        chief_complaint: document.getElementById('chiefComplaintSOAP').value, 
        subjective: document.getElementById('subjective').value, 
        objective: document.getElementById('objective').value, 
        assessment: document.getElementById('assessment').value, 
        plan: document.getElementById('plan').value 
      }]);
      
      showToast('SOAP notes saved!', 'success');
      closeModal();
      render();
    }

    // ============================================
    // LAB ORDERS MODULE (Phase 7)
    // ============================================
    function showLabOrderModal(patientId) {
      const patient = DB.patients.find(p => p.id === patientId);
      window.selectedLabTests = [];
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="p-8 border-b flex justify-between items-center">
            <div>
              <h2 class="text-2xl font-bold">üî¨ Lab Orders</h2>
              <p class="text-sm text-gray-600 mt-1">Patient: ${patient.first_name} ${patient.last_name || ''}</p>
            </div>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
          </div>
          <div class="p-8">
            <div id="labTestResults" class="space-y-3 mb-6">
              ${DB.lab_tests.map(test => `
                <div class="p-4 border rounded-xl hover:bg-blue-50">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <p class="font-bold">${test.name}</p>
                      <p class="text-sm text-gray-600">${test.category} ‚Ä¢ ‚Çπ${test.price}</p>
                    </div>
                    <button onclick="addLabTest('${test.id}')" class="btn btn-primary">Add</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div id="selectedTests" class="mb-6">
              <h3 class="font-bold mb-3">Selected (0)</h3>
              <div id="selectedTestsList"></div>
            </div>
            <div class="flex gap-4">
              <button onclick="submitLabOrder('${patientId}')" class="btn btn-success">Submit</button>
              <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function addLabTest(testId) {
      const test = DB.lab_tests.find(t => t.id === testId);
      if (!window.selectedLabTests.find(t => t.id === testId)) {
        window.selectedLabTests.push(test);
        updateSelectedTestsList();
      }
    }

    function updateSelectedTestsList() {
      const total = window.selectedLabTests.reduce((sum, test) => sum + test.price, 0);
      document.querySelector('#selectedTests h3').textContent = `Selected (${window.selectedLabTests.length}) - ‚Çπ${total}`;
      document.getElementById('selectedTestsList').innerHTML = window.selectedLabTests.map(test => `
        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg mb-2">
          <div>
            <p class="font-semibold text-sm">${test.name}</p>
            <p class="text-xs text-gray-600">‚Çπ${test.price}</p>
          </div>
          <button onclick="removeLabTest('${test.id}')" class="text-red-600">‚úï</button>
        </div>
      `).join('');
    }

    function removeLabTest(testId) {
      window.selectedLabTests = window.selectedLabTests.filter(t => t.id !== testId);
      updateSelectedTestsList();
    }

    async function submitLabOrder(patientId) {
      if (window.selectedLabTests.length === 0) { showToast('Select at least one test', 'error'); return; }
      await supabase.from('lab_orders').insert([{ 
        patient_id: patientId, 
        tests: window.selectedLabTests, 
        total_amount: window.selectedLabTests.reduce((sum, test) => sum + test.price, 0), 
        status: 'pending' 
      }]);
      
      showToast(`Lab order created! ${window.selectedLabTests.length} tests`, 'success');
      closeModal();
      render();
    }

    // ============================================
    // RENDER ENGINE
    // ============================================
    function render() {
      const app = document.getElementById('app');
      const clinic = getClinic();
      
      if (currentScreen === 'consent') {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-6" style="background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #138808 100%);">
            <div class="w-full max-w-2xl">
              <div class="text-center mb-10">
                <img src="${clinic.logo_url}" class="h-20 mx-auto mb-6">
                <h1 class="text-4xl font-bold text-gray-900 mb-3">${clinic.name}</h1>
                <p class="text-xl text-gray-700">AI-Powered Healthcare System</p>
                <p class="text-lg text-gray-600 mt-2">Phase 8: AI Foundation Complete</p>
              </div>
              <div class="card">
                <h2 class="text-2xl font-bold mb-4">üìã Data Privacy Consent</h2>
                <p class="text-gray-700 mb-4">As per DPDP Act 2023, we require your consent.</p>
                <button onclick="acceptConsent()" class="btn btn-primary w-full">Accept & Continue</button>
              </div>
            </div>
          </div>
        `;
      } else if (currentScreen === 'login') {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center p-6" style="background: linear-gradient(135deg, ${clinic.primary_color} 0%, ${clinic.secondary_color} 100%);">
            <div class="w-full max-w-md">
              <div class="text-center mb-10">
                <img src="${clinic.logo_url}" class="h-16 mx-auto mb-6">
                <h1 class="text-4xl font-bold text-white mb-3">${clinic.name}</h1>
                <p class="text-white text-lg">ü§ñ AI-Powered System</p>
                <p class="text-white text-sm mt-2 opacity-90">Phase 8 Complete</p>
              </div>
              <div class="card">
                <input type="email" value="doctor@clinic.com" class="form-input mb-4">
                <button onclick="login()" class="btn btn-primary w-full">Login</button>
              </div>
            </div>
          </div>
        `;
      } else {
        app.innerHTML = `
          <div>
            <nav class="bg-gray-900 text-white p-5 flex justify-between sticky top-0 z-50">
              <div class="flex gap-4 items-center">
                <img src="${clinic.logo_url}" class="h-10">
                <div>
                  <h3 class="font-bold">${clinic.name}</h3>
                  <p class="text-xs text-gray-300">ü§ñ AI-Powered ‚Ä¢ Phase 8 Complete ‚úÖ</p>
                </div>
              </div>
              <div class="flex items-center gap-4">
                <button onclick="showAIDiagnosisHelper()" class="btn btn-sm btn-ai">ü§ñ AI Diagnosis</button>
                <div class="text-right">
                  <p class="font-semibold">${currentUser?.name}</p>
                  <p class="text-xs text-gray-300">${currentUser?.email}</p>
                </div>
                <button onclick="logout()" class="px-4 py-2 bg-white bg-opacity-10 rounded-lg hover:bg-opacity-20">Logout</button>
              </div>
            </nav>
            <div class="flex">
              <aside class="w-72 bg-gray-800 text-white p-6 min-h-screen">
                <div class="mb-6 p-4 rounded-xl" style="background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);">
                  <p class="text-xs font-bold">ü§ñ AI POWERED</p>
                  <p class="text-xs mt-1">Phase 8 Complete</p>
                </div>
                <nav class="space-y-2">
                  <a onclick="switchScreen('dashboard')" class="nav-link ${currentScreen==='dashboard'?'active':''}">üìä Dashboard</a>
                  <a onclick="switchScreen('opd_queue')" class="nav-link ${currentScreen==='opd_queue'?'active':''}">üé´ OPD Queue</a>
                  <a onclick="switchScreen('patients')" class="nav-link ${currentScreen==='patients'?'active':''}">üë• Patients</a>
                  <a onclick="switchScreen('prescriptions')" class="nav-link ${currentScreen==='prescriptions'?'active':''}">üíä Prescriptions</a>
                  <a onclick="switchScreen('billing')" class="nav-link ${currentScreen==='billing'?'active':''}">üí∞ Billing</a>
                  <a onclick="switchScreen('clinical')" class="nav-link ${currentScreen==='clinical'?'active':''}">üè• Clinical</a>
                </nav>
              </aside>
              <main class="flex-1 p-8">${renderContent()}</main>
            </div>
          </div>
        `;
        
        // Render chatbot
        renderChatbot();
      }
    }

    function renderContent() {
      const clinic = getClinic();
      
      if (currentScreen === 'dashboard') {
        return `
          <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold mb-8">Dashboard - AI-Powered System</h1>
            
            <div class="mb-8 p-6 rounded-xl border-l-4" style="background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 100%); border-left-color: #ec4899;">
              <div class="flex items-center gap-4">
                <div class="text-4xl">ü§ñ</div>
                <div>
                  <p class="font-bold text-lg" style="color: #ec4899;">PHASE 8: AI FOUNDATION COMPLETE!</p>
                  <p class="text-sm text-gray-700">AI Prescription Assistant ‚Ä¢ Voice-to-Text ‚Ä¢ AI Diagnosis ‚Ä¢ Chatbot ‚Ä¢ Smart Search</p>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-4 gap-6 mb-8">
              <div class="card">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl" style="background: ${clinic.primary_color};">üë•</div>
                  <div><p class="text-gray-600 text-sm">Patients</p><p class="text-3xl font-bold">${DB.patients.length}</p></div>
                </div>
              </div>
              <div class="card">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white text-2xl" style="background: ${clinic.secondary_color};">üíä</div>
                  <div><p class="text-gray-600 text-sm">Prescriptions</p><p class="text-3xl font-bold">${DB.prescriptions.length}</p></div>
                </div>
              </div>
              <div class="card">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center text-white text-2xl">üí∞</div>
                  <div><p class="text-gray-600 text-sm">Invoices</p><p class="text-3xl font-bold">${DB.invoices.length}</p></div>
                </div>
              </div>
              <div class="card">
                <div class="flex items-center gap-4">
                  <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center text-white text-2xl">üé´</div>
                  <div><p class="text-gray-600 text-sm">OPD Queue</p><p class="text-3xl font-bold">${DB.opd_queue.length}</p></div>
                </div>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
              <div class="card">
                <h3 class="text-xl font-bold mb-4">üéØ Quick Actions</h3>
                <div class="space-y-3">
                  <button onclick="showAddPatientModal()" class="btn btn-success w-full">üë§ Add Patient</button>
                  <button onclick="showAddToQueueModal()" class="btn btn-primary w-full">üé´ Add to Queue</button>
                  <button onclick="showAIDiagnosisHelper()" class="btn btn-ai w-full">ü§ñ AI Diagnosis Assistant</button>
                </div>
              </div>
              <div class="card">
                <h3 class="text-xl font-bold mb-4">ü§ñ AI Features</h3>
                <div class="space-y-2 text-sm">
                  <div class="flex items-center gap-2"><span class="text-green-600">‚úì</span><span>AI Prescription Assistant</span></div>
                  <div class="flex items-center gap-2"><span class="text-green-600">‚úì</span><span>Voice-to-Text (SOAP Notes)</span></div>
                  <div class="flex items-center gap-2"><span class="text-green-600">‚úì</span><span>AI Diagnosis Support</span></div>
                  <div class="flex items-center gap-2"><span class="text-green-600">‚úì</span><span>AI Chatbot (Click bottom-right)</span></div>
                  <div class="flex items-center gap-2"><span class="text-green-600">‚úì</span><span>Smart Medicine Search</span></div>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      if (currentScreen === 'patients') {
        return `
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
              <h1 class="text-3xl font-bold">üë• Patient Management</h1>
              <button onclick="showAddPatientModal()" class="btn btn-success">+ Add Patient</button>
            </div>
            <div class="space-y-4">
              ${DB.patients.map(p => `
                <div class="card">
                  <div class="flex justify-between items-start">
                    <div class="flex-1">
                      <h3 class="text-xl font-bold mb-2">${p.first_name} ${p.last_name || ''}</h3>
                      <div class="flex gap-3 mb-2">
                        <span class="badge badge-primary">${p.patient_id}</span>
                        <span class="text-gray-600">${p.age}Y ${p.gender}</span>
                        <span class="text-gray-600">${p.blood_group || 'N/A'}</span>
                      </div>
                      <p class="text-gray-600">üìû ${p.phone}</p>
                    </div>
                    <div class="flex gap-3 flex-wrap">
                      <button onclick="showPrescriptionModal('${p.id}')" class="btn btn-primary">üíä Rx <span class="ai-badge ml-1">AI</span></button>
                      <button onclick="showInvoiceModal('${p.id}')" class="btn btn-success">üí∞ Bill</button>
                      <button onclick="showVitalSignsModal('${p.id}')" class="btn btn-info">ü©∫ Vitals</button>
                      <button onclick="showSOAPNotesModal('${p.id}')" class="btn btn-warning">üìã SOAP <span class="ai-badge ml-1">üé§</span></button>
                      <button onclick="showLabOrderModal('${p.id}')" class="btn btn-purple">üî¨ Lab</button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      if (currentScreen === 'prescriptions') {
        return `<div class="max-w-7xl mx-auto"><h1 class="text-3xl font-bold mb-8">üíä Prescriptions</h1><div class="card"><p class="text-gray-600">Total: <span class="font-bold">${DB.prescriptions.length}</span></p>${DB.prescriptions.length === 0 ? '<p class="text-gray-500 mt-4">No prescriptions yet. Go to Patients to create one with AI assistance!</p>' : ''}</div></div>`;
      }

      if (currentScreen === 'billing') {
        return `<div class="max-w-7xl mx-auto"><h1 class="text-3xl font-bold mb-8">üí∞ GST Billing</h1><div class="card"><p class="text-gray-600">Total Invoices: <span class="font-bold">${DB.invoices.length}</span></p>${DB.invoices.length === 0 ? '<p class="text-gray-500 mt-4">No invoices yet. Go to Patients to create one.</p>' : ''}</div></div>`;
      }

      if (currentScreen === 'opd_queue') {
        const today = new Date().toISOString().split('T')[0];
        const todayQueue = DB.opd_queue.filter(q => q.date === today);
        return `
          <div class="max-w-7xl mx-auto">
            <div class="flex justify-between items-center mb-8">
              <h1 class="text-3xl font-bold">üé´ OPD Queue</h1>
              <button onclick="showAddToQueueModal()" class="btn btn-success">+ Add to Queue</button>
            </div>
            <div class="space-y-4">
              ${todayQueue.length === 0 ? '<div class="card text-center py-12"><div class="text-6xl mb-4">üé´</div><p class="text-xl text-gray-600">No patients in queue</p><button onclick="showAddToQueueModal()" class="btn btn-primary mt-4">Add First Patient</button></div>' : todayQueue.map(q => `
                <div class="card">
                  <div class="flex justify-between items-start">
                    <div class="flex gap-6 flex-1">
                      <div class="text-center"><div class="text-5xl font-bold text-blue-600">${q.token_number}</div></div>
                      <div class="flex-1">
                        <h3 class="text-xl font-bold mb-2">${q.patient_name}</h3>
                        <p class="text-gray-600 text-sm">üí¨ ${q.chief_complaint || 'No complaint'}</p>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      if (currentScreen === 'clinical') {
        return `
          <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold mb-8">üè• Clinical Records</h1>
            <div class="grid grid-cols-3 gap-8">
              <div class="card"><h3 class="text-xl font-bold mb-4">ü©∫ Vital Signs</h3><div class="text-4xl font-bold text-blue-600">${DB.vital_signs.length}</div><p class="text-sm text-gray-500 mt-2">Total records</p></div>
              <div class="card"><h3 class="text-xl font-bold mb-4">üìã SOAP Notes</h3><div class="text-4xl font-bold text-purple-600">${DB.soap_notes.length}</div><p class="text-sm text-gray-500 mt-2">Total notes</p></div>
              <div class="card"><h3 class="text-xl font-bold mb-4">üî¨ Lab Orders</h3><div class="text-4xl font-bold text-orange-600">${DB.lab_orders.length}</div><p class="text-sm text-gray-500 mt-2">Total orders</p></div>
            </div>
          </div>
        `;
      }

      return `<div class="card"><h1 class="text-2xl font-bold mb-4">${currentScreen}</h1><p>Content for ${currentScreen}</p></div>`;
    }

    // Initialize app
    console.log('‚úÖ Phase 8: AI Foundation - All modules loaded!');
    render();
  </script>
</body>
</html>